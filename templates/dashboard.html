{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

<div class="admin-header">
  <h2>Admin Dashboard</h2>
  <nav class="admin-tabs">
    <a href="{{ url_for('admin.dashboard') }}" class="active">Overview</a>
    <a href="{{ url_for('admin.category1_listings') }}">Category 1</a>
    <a href="{{ url_for('admin.category2_listings') }}">Category 2</a>
    <a href="{{ url_for('admin.category3_products') }}">Category 3</a>
    <a href="{{ url_for('admin.users') }}">Users</a>
    <a href="{{ url_for('admin.analytics') }}">Analytics</a>
    <a href="{{ url_for('admin.settings') }}">Settings</a>
  </nav>
</div>

<div class="cards-grid">
  <div class="stat-card blue">
    <div class="icon">üë•</div>
    <div class="meta">
      <div class="label">Total Users</div>
      <div class="value">{{ total_users }}</div>
    </div>
  </div>

  <div class="stat-card green">
    <div class="icon">‚úÖ</div>
    <div class="meta">
      <div class="label">Active Users</div>
      <div class="value">{{ active_users }}</div>
    </div>
  </div>

  <div class="stat-card purple">
    <div class="icon">üõÑ</div>
    <div class="meta">
      <div class="label">Cat 1 Listings</div>
      <div class="value">{{ cat1_total }} ({{ cat1_pending }} pending)</div>
    </div>
  </div>

  <div class="stat-card orange">
    <div class="icon">üß≠</div>
    <div class="meta">
      <div class="label">Cat 2 Listings</div>
      <div class="value">{{ cat2_total }} ({{ cat2_pending }} pending)</div>
    </div>
  </div>

  <div class="stat-card pink">
    <div class="icon">üõçÔ∏è</div>
    <div class="meta">
      <div class="label">Cat 3 Products</div>
      <div class="value">{{ cat3_total }} ({{ cat3_pending }} pending)</div>
    </div>
  </div>

  <div class="stat-card teal">
    <div class="icon">üìä</div>
    <div class="meta">
      <div class="label">Site Visits</div>
      <div class="value">{{ total_visits }} total ‚Ä¢ {{ today_visits }} today</div>
    </div>
  </div>
</div>

<div class="panel-grid">
  
  <!-- ============================================
       ‚úÖ NEW: PENDING MANUAL PAYMENTS SECTION
       ============================================ -->
  {% if pending_manual_payments > 0 %}
  <section class="panel" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
    <h3 style="color: #92400e; display: flex; align-items: center; gap: 10px;">
      <span>‚ö†Ô∏è</span>
      <span>Pending Manual Payments</span>
      <span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9rem; margin-left: auto;">{{ pending_manual_payments }}</span>
    </h3>
    <p style="color: #92400e; margin: 12px 0 20px 0;">
      <strong>{{ pending_manual_payments }}</strong> manual payment(s) awaiting your verification (Wise, Bank Transfer, PayID, Mobile Banking)
    </p>
    <a href="{{ url_for('admin.pending_payments') }}" style="display: inline-block; padding: 12px 24px; background: #f59e0b; color: white; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.2s;">
      Review Pending Payments ‚Üí
    </a>
  </section>
  {% endif %}

  <!-- Category 1 Pending Approvals -->
  <section class="panel">
    <h3>Pending Approvals ‚Äì Category 1</h3>
    {% if pending_cat1 %}
    <table class="listing">
      <tr><th>ID</th><th>Title</th><th>Route</th><th>Date</th><th>Price</th><th>Action</th></tr>
      {% for l in pending_cat1 %}
      <tr>
        <td>{{ l.id }}</td>
        <td>{{ l.title }}</td>
        <td>{{ l.origin }} ‚Üí {{ l.destination }}</td>
        <td>{{ l.travel_date }}</td>
        <td>${{ "%.2f"|format(l.price_per_kg * l.total_weight) }}</td>
        <td>
          <form method="post" action="{{ url_for('admin.update_category1_status', listing_id=l.id) }}">
            <select name="status" required>
              <option value="">--set--</option>
              <option value="approved">Approve</option>
              <option value="rejected">Reject</option>
            </select>
            <button>Save</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>
    {% else %}
    <p>No pending items.</p>
    {% endif %}
  </section>

  <!-- Category 2 Pending Approvals -->
  <section class="panel">
    <h3>Pending Approvals ‚Äì Category 2</h3>
    {% if pending_cat2 %}
    <table class="listing">
      <tr><th>ID</th><th>Name</th><th>Travel</th><th>Action</th></tr>
      {% for l in pending_cat2 %}
      <tr>
        <td>{{ l.id }}</td>
        <td>{{ l.name }}</td>
        <td>{{ l.travel_from or 'N/A' }} ‚Üí {{ l.travel_to or 'N/A' }}</td>
        <td>
          <form method="post" action="{{ url_for('admin.update_category2_status', listing_id=l.id) }}">
            <select name="status" required>
              <option value="">--set--</option>
              <option value="approved">Approve</option>
              <option value="rejected">Reject</option>
            </select>
            <button>Save</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>
    {% else %}
    <p>No pending items.</p>
    {% endif %}
  </section>

  <!-- Category 3 Pending Approvals -->
  <section class="panel">
    <h3>Pending Approvals ‚Äì Category 3</h3>
    {% if pending_cat3 %}
    <table class="listing">
      <tr><th>ID</th><th>Product</th><th>Price</th><th>Action</th></tr>
      {% for p in pending_cat3 %}
      <tr>
        <td>{{ p.id }}</td>
        <td>{{ p.product_name }}</td>
        <td>${{ "%.2f"|format(p.price) }}</td>
        <td>
          <form method="post" action="{{ url_for('admin.update_category3_status', product_id=p.id) }}">
            <select name="status" required>
              <option value="">--set--</option>
              <option value="approved">Approve</option>
              <option value="rejected">Reject</option>
            </select>
            <button>Save</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>
    {% else %}
    <p>No pending items.</p>
    {% endif %}
  </section>

  <!-- Recent Users -->
  <section class="panel">
    <h3>Recent Users</h3>
    <table class="listing">
      <tr><th>Email</th><th>Name</th><th>Created</th></tr>
      {% for u in recent_users %}
      <tr>
        <td>{{ u.email }}</td>
        <td>{{ u.full_name }}</td>
        <td>{{ u.created_at.strftime('%Y-%m-%d') }}</td>
      </tr>
      {% endfor %}
    </table>
  </section>

  <!-- Site Activity -->
  <section class="panel">
    <h3>Recent Activity</h3>
    <ul style="list-style: none; padding: 0;">
      <li style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
        <strong>Today's logins:</strong> {{ logins_last_n }}
      </li>
      <li style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
        <strong>Site visits today:</strong> {{ today_visits }}
      </li>
      <li style="padding: 8px 0;">
        <strong>Total site visits:</strong> {{ total_visits }}
      </li>
    </ul>
  </section>

  <!-- Top Pages -->
  <section class="panel">
    <h3>Top Pages (by visits)</h3>
    {% if top_pages %}
    <table class="listing">
      <tr><th>URL</th><th>Visits</th></tr>
      {% for url, cnt in top_pages %}
      <tr><td>{{ url }}</td><td>{{ cnt }}</td></tr>
      {% endfor %}
    </table>
    {% else %}
    <p>No data yet.</p>
    {% endif %}
  </section>
</div>
{% endblock %}