{% extends "base.html" %}
{% block title %}My Account - Maa Express{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/account.css') }}">
{% endblock %}

{% block content %}
<!-- Account Header -->
<div class="account-header">
  <div class="account-header-content">
    <h1>üë§ My Account</h1>
    <p class="account-subtitle">Welcome back, {{ user.full_name }}</p>
  </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
        <div class="flash-message flash-{{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Main Account Content -->
<div class="account-container">
  
  <!-- ============================================
       USER PROFILE CARD
       ============================================ -->
  <section class="account-section">
    <h2 class="section-title">üë§ Profile Information</h2>
    
    <div class="profile-card">
      <div class="profile-avatar">
        <div class="avatar-circle">
          {{ user.full_name[0]|upper }}
        </div>
      </div>
      
      <div class="profile-details">
        <div class="profile-detail-grid">
          <div class="profile-detail-item">
            <span class="profile-label">Full Name:</span>
            <span class="profile-value">{{ user.full_name }}</span>
          </div>
          
          <div class="profile-detail-item">
            <span class="profile-label">Email:</span>
            <div class="profile-value">
              {{ user.email }}
              {% if user.email_verified %}
                <span class="verified-badge">‚úì Verified</span>
              {% else %}
                <span class="unverified-badge">‚úó Not Verified</span>
              {% endif %}
            </div>
          </div>
          
          <div class="profile-detail-item">
            <span class="profile-label">Phone:</span>
            <div class="profile-value">
              {{ user.phone or 'Not provided' }}
              {% if user.phone_verified %}
                <span class="verified-badge">‚úì Verified</span>
              {% else %}
                <span class="unverified-badge">‚úó Not Verified</span>
              {% endif %}
            </div>
          </div>
          
          <div class="profile-detail-item">
            <span class="profile-label">Member Since:</span>
            <span class="profile-value">{{ user.created_at.strftime('%B %d, %Y') }}</span>
          </div>
          
          <div class="profile-detail-item">
            <span class="profile-label">Account Status:</span>
            <span class="profile-value">
              {% if user.is_active %}
                <span class="status-badge status-approved">Active</span>
              {% else %}
                <span class="status-badge status-rejected">Inactive</span>
              {% endif %}
            </span>
          </div>
          
          <div class="profile-detail-item">
            <span class="profile-label">Role:</span>
            <span class="profile-value">
              {% if user.is_admin %}
                <span class="admin-badge">üëë Admin</span>
              {% else %}
                <span class="user-badge">User</span>
              {% endif %}
            </span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================================
       MY PURCHASES SECTION - WITH CODES DISPLAY
       ============================================ -->
  <section class="account-section">
    <h2 class="section-title">üì¶ My Purchases</h2>
    
    {% if cat1_purchases %}
      <div class="purchases-grid">
        {% for purchase in cat1_purchases %}
          <div class="purchase-card">
            <div class="purchase-header">
              <div class="purchase-title-group">
                <h3 class="purchase-title">
                  Order #{{ purchase.id }}
                </h3>
                <p class="purchase-route">
                  {% if purchase.listing %}
                    <span class="route-from">{{ purchase.listing.origin }}</span>
                    <span class="route-arrow">‚Üí</span>
                    <span class="route-to">{{ purchase.listing.destination }}</span>
                  {% else %}
                    <span style="color: #9ca3af;">Listing Unavailable</span>
                  {% endif %}
                </p>
              </div>
              <span class="status-badge status-{{ purchase.status }}">
                {{ purchase.status.replace('_', ' ')|title }}
              </span>
            </div>

            <div class="purchase-body">
              <!-- Purchase Meta Info -->
              <div class="purchase-meta">
                <div class="meta-item">
                  <span class="meta-icon">üìÖ</span>
                  <span>{{ purchase.created_at.strftime('%d %b %Y') }}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-icon">‚öñÔ∏è</span>
                  <span>{{ purchase.purchased_weight or 0 }} kg</span>
                </div>
                <div class="meta-item">
                  <span class="meta-icon">üí∞</span>
                  <span>
                    {% if purchase.listing %}
                      {{ purchase.listing.currency }}
                    {% endif %}
                    ${{ "%.2f"|format(purchase.purchase_price if purchase.purchase_price else 0.00) }}
                  </span>
                </div>
              </div>

              <!-- Purchase Details Grid -->
              <div class="purchase-details-grid">
                <div class="detail-item">
                  <span class="detail-label">Payment Method:</span>
                  <span class="detail-value">{{ purchase.payment_method or 'N/A' }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Payment Status:</span>
                  <span class="detail-value">
                    {% if purchase.payment_status == 'paid' %}
                      <span class="verified-badge">‚úì Paid</span>
                    {% elif purchase.payment_status == 'manual_pay' %}
                      <span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">‚è≥ Verifying</span>
                    {% elif purchase.payment_status == 'failed' %}
                      <span style="background: #fee2e2; color: #991b1b; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">‚úó Failed</span>
                    {% else %}
                      <span class="unverified-badge">{{ purchase.payment_status|capitalize }}</span>
                    {% endif %}
                  </span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Receiver:</span>
                  <span class="detail-value">{{ purchase.receiver_fullname or 'N/A' }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Delivery Address:</span>
                  <span class="detail-value">
                    {{ purchase.delivery_address or 'N/A' }}, {{ purchase.delivery_country or '' }}
                  </span>
                </div>
              </div>

              <!-- ============================================
                   ‚úÖ CODES DISPLAY - FIXED VERSION
                   ============================================ -->
              {% if purchase.payment_status == 'paid' %}
                <!-- ‚úÖ PAYMENT VERIFIED - SHOW CODES -->
                <div style="background: #d1fae5; padding: 14px; border-radius: 8px; margin-top: 12px; border: 2px solid #10b981;">
                  <strong style="color: #065f46;">‚úÖ Payment Verified</strong>
                  <p style="color: #065f46; margin: 8px 0 0 0; font-size: 0.9rem;">
                    Your payment has been verified. Handover and delivery codes are below.
                  </p>
                </div>

                <!-- ‚úÖ CODES DISPLAY -->
                <div style="background: #eff6ff; padding: 20px; border-radius: 8px; margin-top: 16px; border: 2px solid #1a73e8;">
                  <h4 style="color: #1a73e8; margin: 0 0 16px 0; font-size: 1.1rem;">üîê Your Verification Codes</h4>
                  
                  <div style="display: grid; gap: 16px;">
                    <!-- Handover Code -->
                    <div style="background: white; padding: 14px; border-radius: 6px; border: 1px solid #d1d5db;">
                      <p style="margin: 0 0 6px 0; color: #6b7280; font-size: 0.85rem; font-weight: 600;">
                        üîë HANDOVER CODE (Give to seller at origin)
                      </p>
                      <code style="font-size: 1.4rem; font-weight: 700; color: #1a73e8; letter-spacing: 2px; font-family: 'Courier New', monospace;">
                        {{ purchase.handover_code if purchase.handover_code and purchase.handover_code != 'PENDING' else 'PENDING - Contact Admin' }}
                      </code>
                      {% if purchase.handover_verified_at %}
                        <p style="margin: 8px 0 0 0; color: #10b981; font-size: 0.85rem; font-weight: 600;">
                          ‚úì Verified on {{ purchase.handover_verified_at.strftime('%d %b %Y at %H:%M') }}
                        </p>
                      {% endif %}
                    </div>

                    <!-- Delivery Code -->
                    <div style="background: white; padding: 14px; border-radius: 6px; border: 1px solid #d1d5db;">
                      <p style="margin: 0 0 6px 0; color: #6b7280; font-size: 0.85rem; font-weight: 600;">
                        üéØ DELIVERY CODE (Give to receiver at destination)
                      </p>
                      <code style="font-size: 1.4rem; font-weight: 700; color: #10b981; letter-spacing: 2px; font-family: 'Courier New', monospace;">
                        {{ purchase.delivery_code if purchase.delivery_code and purchase.delivery_code != 'PENDING' else 'PENDING - Contact Admin' }}
                      </code>
                      {% if purchase.delivery_verified_at %}
                        <p style="margin: 8px 0 0 0; color: #10b981; font-size: 0.85rem; font-weight: 600;">
                          ‚úì Verified on {{ purchase.delivery_verified_at.strftime('%d %b %Y at %H:%M') }}
                        </p>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Instructions -->
                  <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0; color: #92400e; font-size: 0.85rem; line-height: 1.6;">
                      <strong>‚ö†Ô∏è IMPORTANT:</strong><br>
                      ‚Ä¢ Share <strong>Handover Code</strong> only when you physically hand over the parcel<br>
                      ‚Ä¢ Share <strong>Delivery Code</strong> with your receiver for pickup at destination<br>
                      ‚Ä¢ Keep these codes secure and never share publicly
                    </p>
                  </div>
                </div>

              {% elif purchase.payment_status == 'manual_pay' %}
                <!-- ‚è≥ PAYMENT UNDER REVIEW -->
                <div style="background: #fef3c7; padding: 14px; border-radius: 8px; margin-top: 12px; border: 2px solid #f59e0b;">
                  <strong style="color: #92400e;">‚è≥ Payment Under Review</strong>
                  <p style="color: #92400e; margin: 8px 0 0 0; font-size: 0.9rem;">
                    We are verifying your payment. You will receive your codes within 24 hours.
                  </p>
                </div>

              {% elif purchase.payment_status == 'failed' %}
                <!-- ‚ùå PAYMENT REJECTED -->
                <div style="background: #fee2e2; padding: 14px; border-radius: 8px; margin-top: 12px; border: 2px solid #ef4444;">
                  <strong style="color: #991b1b;">‚ùå Payment Rejected</strong>
                  <p style="color: #991b1b; margin: 8px 0 0 0; font-size: 0.9rem;">
                    Your payment was rejected. Please contact support or try again.
                  </p>
                  
                  <!-- ‚úÖ SHOW REJECTION REASON -->
                  {% if purchase.note and '[ADMIN REJECTION' in purchase.note %}
                    <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #ef4444;">
                      <strong style="color: #991b1b; font-size: 0.85rem;">Rejection Reason:</strong>
                      <p style="color: #991b1b; margin: 4px 0 0 0; font-size: 0.85rem;">
                        {{ purchase.note.split('[ADMIN REJECTION')[1].split(']')[1].strip() if '[ADMIN REJECTION' in purchase.note else 'No reason provided' }}
                      </p>
                    </div>
                  {% endif %}
                </div>

              {% elif purchase.payment_status == 'pending' %}
                <!-- ‚ö†Ô∏è PAYMENT PENDING -->
                <div style="background: #fee2e2; padding: 14px; border-radius: 8px; margin-top: 12px; border: 2px solid #ef4444;">
                  <strong style="color: #991b1b;">‚ö†Ô∏è Payment Pending</strong>
                  <p style="color: #991b1b; margin: 8px 0 0 0; font-size: 0.9rem;">
                    Please complete your payment to receive handover and delivery codes.
                  </p>
                  <a href="{{ url_for('category1.payment_page', buyer_info_id=purchase.id) }}" style="display: inline-block; margin-top: 12px; padding: 8px 16px; background: #ef4444; color: white; border-radius: 6px; text-decoration: none; font-weight: 600;">
                    Complete Payment
                  </a>
                </div>
              {% endif %}

              <!-- View Details Button -->
              <div class="purchase-actions">
                <a href="{{ url_for('category1.detail', listing_id=purchase.listing_id) if purchase.listing else '#' }}" 
                   class="btn-view-purchase">
                  üëÅÔ∏è View Listing
                </a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <p>No purchases yet</p>
        <a href="{{ url_for('main.index') }}" class="btn-primary">Browse Listings</a>
      </div>
    {% endif %}
  </section>

  <!-- ============================================
       MY LISTINGS SECTION
       ============================================ -->
  <section class="account-section">
    <div class="section-header">
      <h2 class="section-title">‚úàÔ∏è My Listings</h2>
      <a href="{{ url_for('category1.create_listing') }}" class="btn-create">
        ‚ûï Create New Listing
      </a>
    </div>
    
    {% if cat1_listings %}
      <div class="listings-grid">
        {% for listing in cat1_listings %}
          <div class="listing-card">
            <div class="listing-header">
              <h3 class="listing-title">{{ listing.title }}</h3>
              <span class="status-badge status-{{ listing.admin_status }}">
                {{ listing.admin_status|capitalize }}
              </span>
            </div>
            
            <div class="listing-body">
              <p class="listing-route">
                <span class="route-from">{{ listing.origin }}</span>
                <span class="route-arrow">‚Üí</span>
                <span class="route-to">{{ listing.destination }}</span>
              </p>
              
              <div class="listing-meta">
                <div class="meta-item">
                  <span class="meta-icon">üìÖ</span>
                  <span>{{ listing.travel_date.strftime('%d %b %Y') }}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-icon">‚öñÔ∏è</span>
                  <span>{{ listing.total_weight }} kg</span>
                </div>
                <div class="meta-item">
                  <span class="meta-icon">üí∞</span>
                  <span>{{ listing.currency }} ${{ "%.2f"|format(listing.final_price) }}</span>
                </div>
              </div>
              
              <div class="listing-actions">
                <a href="{{ url_for('category1.detail', listing_id=listing.id) }}" 
                   class="btn-view">
                  üëÅÔ∏è View
                </a>
                <a href="{{ url_for('account.edit_category1', listing_id=listing.id) }}" 
                   class="btn-edit">
                  ‚úèÔ∏è Edit
                </a>
                <button 
                  class="btn-delete" 
                  onclick="if(confirm('Are you sure you want to delete this listing?')) { fetch('{{ url_for('account.delete_category1', listing_id=listing.id) }}', {method: 'POST'}).then(() => window.location.reload()); }"
                >
                  üóëÔ∏è Delete
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">‚úàÔ∏è</div>
        <p>No listings yet</p>
        <a href="{{ url_for('category1.create_listing') }}" class="btn-primary">Create Your First Listing</a>
      </div>
    {% endif %}
  </section>

  <!-- ============================================
       SALES DASHBOARD LINK
       ============================================ -->
  <section class="account-section">
    <div class="sales-cta">
      <div class="sales-cta-content">
        <h3>üìä View Your Sales</h3>
        <p>Manage orders for your listings, verify handovers and deliveries</p>
      </div>
      <a href="{{ url_for('account.sales_dashboard') }}" class="btn-sales">
        Go to Sales Dashboard ‚Üí
      </a>
    </div>
  </section>

  <!-- ============================================
       PAYOUT SETTINGS SECTION
       ============================================ -->
  <section class="account-section">
    <h2 class="section-title">üí≥ Payout Settings (You will receive payment here)</h2>
    
    <form method="post" action="{{ url_for('account.update_payout') }}" class="payout-form">
      <div class="form-group">
        <label class="form-label">Payout Method</label>
        <select name="payout_method_type" class="form-select" required>
          <option value="none" {% if not user.payout_method_type or user.payout_method_type == 'none' %}selected{% endif %}>None (Set later)</option>
          <option value="bank" {% if user.payout_method_type == 'bank' %}selected{% endif %}>Bank Account</option>
          <option value="card" {% if user.payout_method_type == 'card' %}selected{% endif %}>Card</option>
          <option value="mobile_banking" {% if user.payout_method_type == 'mobile_banking' %}selected{% endif %}>Mobile Banking</option>
          <option value="payid" {% if user.payout_method_type == 'payid' %}selected{% endif %}>PayID</option>
        </select>
      </div>

      <!-- Bank Account Fields -->
      <div id="bank-fields" style="display: {% if user.payout_method_type == 'bank' %}block{% else %}none{% endif %};">
        <div class="form-group">
          <label class="form-label">Account Name</label>
          <input type="text" name="bank_account_name" class="form-input" value="{{ user.bank_account_name or '' }}">
        </div>
        <div class="form-group">
          <label class="form-label">Bank Name</label>
          <input type="text" name="bank_name" class="form-input" value="{{ user.bank_name or '' }}">
        </div>
        <div class="form-group">
          <label class="form-label">BSB/Routing Number</label>
          <input type="text" name="bank_bsb_or_routing" class="form-input" value="{{ user.bank_bsb_or_routing or '' }}">
        </div>
        <div class="form-group">
          <label class="form-label">Account Number</label>
          <input type="text" name="bank_account_number" class="form-input" value="{{ user.bank_account_number or '' }}">
        </div>
      </div>

      <!-- Card Fields -->
      <div id="card-fields" style="display: {% if user.payout_method_type == 'card' %}block{% else %}none{% endif %};">
        <div class="form-group">
          <label class="form-label">Cardholder Name</label>
          <input type="text" name="card_holder_name" class="form-input" value="{{ user.card_holder_name or '' }}">
        </div>
        <div class="form-group">
          <label class="form-label">Card Last 4 Digits</label>
          <input type="text" name="card_last4" class="form-input" value="{{ user.card_last4 or '' }}" maxlength="4">
        </div>
        <div class="form-group">
          <label class="form-label">Card Brand</label>
          <select name="card_brand" class="form-select">
            <option value="">--Select--</option>
            <option value="Visa" {% if user.card_brand == 'Visa' %}selected{% endif %}>Visa</option>
            <option value="Mastercard" {% if user.card_brand == 'Mastercard' %}selected{% endif %}>Mastercard</option>
            <option value="Amex" {% if user.card_brand == 'Amex' %}selected{% endif %}>American Express</option>
          </select>
        </div>
      </div>

      <!-- Mobile Banking Fields -->
      <div id="mobile-fields" style="display: {% if user.payout_method_type == 'mobile_banking' %}block{% else %}none{% endif %};">
        <div class="form-group">
          <label class="form-label">Mobile Banking Number - Bkash, Rocket, Nagad, etc.</label>
          <input type="text" name="mobile_banking_number" class="form-input" value="{{ user.mobile_banking_number or '' }}">
        </div>
      </div>

      <!-- PayID Fields -->
      <div id="payid-fields" style="display: {% if user.payout_method_type == 'payid' %}block{% else %}none{% endif %};">
        <div class="form-group">
          <label class="form-label">PayID (Email or Phone)</label>
          <input type="text" name="payid_identifier" class="form-input" value="{{ user.payid_identifier or '' }}">
        </div>
      </div>

      <button type="submit" class="btn-primary">üíæ Save Payout Settings</button>
    </form>
  </section>

</div>

<script>
// Toggle payout fields based on selected method
document.querySelector('select[name="payout_method_type"]').addEventListener('change', function() {
  const method = this.value;
  
  // Hide all fields
  document.getElementById('bank-fields').style.display = 'none';
  document.getElementById('card-fields').style.display = 'none';
  document.getElementById('mobile-fields').style.display = 'none';
  document.getElementById('payid-fields').style.display = 'none';
  
  // Show selected method fields
  if (method === 'bank') {
    document.getElementById('bank-fields').style.display = 'block';
  } else if (method === 'card') {
    document.getElementById('card-fields').style.display = 'block';
  } else if (method === 'mobile_banking') {
    document.getElementById('mobile-fields').style.display = 'block';
  } else if (method === 'payid') {
    document.getElementById('payid-fields').style.display = 'block';
  }
});
</script>

{% endblock %}