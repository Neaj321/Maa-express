{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/create_listing.css') }}">

<div class="create-listing-wrapper">
  <!-- Header -->
  <div class="create-header">
    <div class="header-content">
      <a href="{{ url_for('main.index') }}" class="back-link">
        <span class="back-icon">‚Üê</span> Back to Home
      </a>
      <h1>Create Luggage Space Listing</h1>
      <p class="subtitle">Share your available luggage space with travelers worldwide</p>
    </div>
  </div>

  <!-- Main Form -->
  <div class="create-container">
    <form id="create-listing-form" class="listing-form">
      
      <!-- Basic Information -->
      <section class="form-section">
        <h2 class="section-title">
          <span class="section-icon">üìù</span>
          Basic Information
        </h2>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="title">
              Listing Title <span class="required">*</span>
            </label>
            <input 
              type="text" 
              id="title" 
              name="title" 
              class="form-input"
              placeholder="e.g., Extra 15kg space Sydney to Dhaka"
              required
              maxlength="255"
            >
            <small class="form-hint">Make it descriptive and clear</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="description">
              Description
            </label>
            <textarea 
              id="description" 
              name="description" 
              class="form-textarea"
              rows="4"
              placeholder="Describe your luggage capacity, conditions, pickup/delivery options..."
            ></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="phone_number">
              Contact Phone
            </label>
            <input 
              type="tel" 
              id="phone_number" 
              name="phone_number" 
              class="form-input"
              placeholder="+61 412 345 678"
              value="{{ user.phone if user else '' }}"
            >
            <small class="form-hint">Include country code</small>
          </div>
        </div>
      </section>

      <!-- Origin Details -->
      <section class="form-section">
        <h2 class="section-title">
          <span class="section-icon">‚úàÔ∏è</span>
          Origin (Departure)
        </h2>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="origin">
              Origin City/Country <span class="required">*</span>
            </label>
            <input 
              type="text" 
              id="origin" 
              name="origin" 
              class="form-input"
              placeholder="e.g., Sydney, Australia"
              required
            >
          </div>

          <div class="form-group">
            <label class="form-label" for="origin_airport">
              Airport Code <span class="required">*</span>
            </label>
            <input 
              type="text" 
              id="origin_airport" 
              name="origin_airport" 
              class="form-input"
              placeholder="SYD"
              required
              maxlength="10"
              style="text-transform: uppercase;"
            >
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="origin_delivery_location">
              Pickup Location (Optional)
            </label>
            <input 
              type="text" 
              id="origin_delivery_location" 
              name="origin_delivery_location" 
              class="form-input"
              placeholder="e.g., CBD, Suburbs"
            >
          </div>

          <div class="form-group">
            <label class="form-label" for="origin_delivery_postcode">
              Postcode
            </label>
            <input 
              type="text" 
              id="origin_delivery_postcode" 
              name="origin_delivery_postcode" 
              class="form-input"
              placeholder="2000"
            >
          </div>
        </div>
      </section>

      <!-- Destination Details -->
      <section class="form-section">
        <h2 class="section-title">
          <span class="section-icon">üåç</span>
          Destination (Arrival)
        </h2>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="destination">
              Destination City/Country <span class="required">*</span>
            </label>
            <input 
              type="text" 
              id="destination" 
              name="destination" 
              class="form-input"
              placeholder="e.g., Dhaka, Bangladesh"
              required
            >
          </div>

          <div class="form-group">
            <label class="form-label" for="destination_airport">
              Airport Code <span class="required">*</span>
            </label>
            <input 
              type="text" 
              id="destination_airport" 
              name="destination_airport" 
              class="form-input"
              placeholder="DAC"
              required
              maxlength="10"
              style="text-transform: uppercase;"
            >
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="destination_delivery_location">
              Delivery Location (Optional)
            </label>
            <input 
              type="text" 
              id="destination_delivery_location" 
              name="destination_delivery_location" 
              class="form-input"
              placeholder="e.g., Gulshan, Dhanmondi"
            >
          </div>

          <div class="form-group">
            <label class="form-label" for="destination_delivery_postcode">
              Postcode
            </label>
            <input 
              type="text" 
              id="destination_delivery_postcode" 
              name="destination_delivery_postcode" 
              class="form-input"
              placeholder="1212"
            >
          </div>
        </div>
      </section>

      <!-- Travel Date -->
      <section class="form-section">
        <h2 class="section-title">
          <span class="section-icon">üìÖ</span>
          Travel Date
        </h2>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="travel_date">
              Date of Travel <span class="required">*</span>
            </label>
            <input 
              type="date" 
              id="travel_date" 
              name="travel_date" 
              class="form-input"
              required
              min="{{ today }}"
            >
          </div>
        </div>
      </section>

      <!-- Pricing -->
      <section class="form-section">
        <h2 class="section-title">
          <span class="section-icon">üí∞</span>
          Pricing
        </h2>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="price">
              Total Price (AUD) <span class="required">*</span>
            </label>
            <input 
              type="number" 
              id="price" 
              name="price" 
              class="form-input"
              placeholder="150.00"
              step="0.01"
              min="0"
              required
            >
            <small class="form-hint">Your asking price for the luggage space</small>
          </div>

          <div class="form-group">
            <label class="form-label" for="price_per_kg">
              Price per KG (Optional)
            </label>
            <input 
              type="number" 
              id="price_per_kg" 
              name="price_per_kg" 
              class="form-input"
              placeholder="10.00"
              step="0.01"
              min="0"
            >
            <small class="form-hint">Helpful for buyers to calculate costs</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="discount_percent">
              Discount (%)
            </label>
            <input 
              type="number" 
              id="discount_percent" 
              name="discount_percent" 
              class="form-input"
              placeholder="0"
              step="0.01"
              min="0"
              max="100"
              value="0"
            >
            <small class="form-hint">Optional promotional discount</small>
          </div>

          <div class="form-group">
            <label class="form-label">
              Final Price
            </label>
            <div class="final-price-display" id="final-price-display">
              AUD $0.00
            </div>
            <small class="form-hint">Automatically calculated</small>
          </div>
        </div>
      </section>

      <!-- Image Upload -->
      <section class="form-section">
        <h2 class="section-title">
          <span class="section-icon">üì∑</span>
          Photo (Optional)
        </h2>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="image-file">
              Upload Image
            </label>
            <input 
              type="file" 
              id="image-file" 
              accept="image/*"
              class="form-input-file"
            >
            <small class="form-hint">Max 5MB. Supported: JPG, PNG, WebP</small>
            
            <div id="image-preview" class="image-preview" style="display:none;">
              <img id="preview-img" src="" alt="Preview">
              <button type="button" id="remove-image" class="btn-remove-image">Remove</button>
            </div>
            
            <input type="hidden" id="image_url" name="image_url">
          </div>
        </div>
      </section>

      <!-- Terms & Submit -->
      <section class="form-section">
        <div class="form-row">
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="terms" required>
              <span>I agree to the <a href="/page/terms.html" target="_blank">Terms of Service</a> and <a href="/page/privacy.html" target="_blank">Privacy Policy</a></span>
            </label>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" onclick="window.history.back()" class="btn-secondary">
            Cancel
          </button>
          <button type="submit" id="submit-btn" class="btn-primary">
            <span id="submit-text">Create Listing</span>
            <span id="submit-spinner" class="spinner" style="display:none;">Creating...</span>
          </button>
        </div>
      </section>

      <p id="form-message" class="form-message"></p>
    </form>
  </div>
</div>

<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "{{ config.FIREBASE_API_KEY }}",
    authDomain: "{{ config.FIREBASE_AUTH_DOMAIN }}",
    projectId: "{{ config.FIREBASE_PROJECT_ID }}",
    storageBucket: "{{ config.FIREBASE_STORAGE_BUCKET }}",
    appId: "{{ config.FIREBASE_APP_ID }}"
  };

  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const storage = getStorage(app);

  const form = document.getElementById("create-listing-form");
  const msgEl = document.getElementById("form-message");
  const submitBtn = document.getElementById("submit-btn");
  const submitText = document.getElementById("submit-text");
  const submitSpinner = document.getElementById("submit-spinner");
  const imageFileInput = document.getElementById("image-file");
  const imagePreview = document.getElementById("image-preview");
  const previewImg = document.getElementById("preview-img");
  const removeImageBtn = document.getElementById("remove-image");
  const imageUrlInput = document.getElementById("image_url");

  // Auto-calculate final price
  const priceInput = document.getElementById("price");
  const discountInput = document.getElementById("discount_percent");
  const finalPriceDisplay = document.getElementById("final-price-display");

  function updateFinalPrice() {
    const price = parseFloat(priceInput.value) || 0;
    const discount = parseFloat(discountInput.value) || 0;
    const finalPrice = price - (price * (discount / 100));
    finalPriceDisplay.textContent = `AUD $${finalPrice.toFixed(2)}`;
  }

  priceInput.addEventListener("input", updateFinalPrice);
  discountInput.addEventListener("input", updateFinalPrice);

  // Image preview
  imageFileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        previewImg.src = event.target.result;
        imagePreview.style.display = "block";
      };
      reader.readAsDataURL(file);
    }
  });

  removeImageBtn.addEventListener("click", () => {
    imageFileInput.value = "";
    imageUrlInput.value = "";
    imagePreview.style.display = "none";
  });

  // Upload image to Firebase Storage
  async function uploadImage(file) {
    const timestamp = Date.now();
    const storageRef = ref(storage, `category1/listings/${timestamp}_${file.name}`);
    await uploadBytes(storageRef, file);
    return await getDownloadURL(storageRef);
  }

  // Form submission
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    msgEl.textContent = "";
    msgEl.className = "form-message";
    submitBtn.disabled = true;
    submitText.style.display = "none";
    submitSpinner.style.display = "inline";

    try {
      // Upload image if selected
      const imageFile = imageFileInput.files[0];
      if (imageFile) {
        msgEl.textContent = "Uploading image...";
        const imageUrl = await uploadImage(imageFile);
        imageUrlInput.value = imageUrl;
      }

      msgEl.textContent = "Creating listing...";

      // Prepare form data
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // Send to backend
      const response = await fetch("{{ url_for('category1.create_listing') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || "Failed to create listing");
      }

      msgEl.textContent = result.message;
      msgEl.className = "form-message success";
      
      // Redirect after 2 seconds
      setTimeout(() => {
        window.location.href = "{{ url_for('account.account') }}";
      }, 2000);

    } catch (error) {
      console.error(error);
      msgEl.textContent = "Error: " + error.message;
      msgEl.className = "form-message error";
      submitBtn.disabled = false;
      submitText.style.display = "inline";
      submitSpinner.style.display = "none";
    }
  });

  // Set min date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("travel_date").setAttribute("min", today);
</script>
{% endblock %}